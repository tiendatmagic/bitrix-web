{"version":3,"file":"security.bundle.js","sources":["../src/security.js"],"sourcesContent":["import {Dom, Event, Type} from 'main.core';\n\nexport class Security\n{\n\tconstructor(params = {})\n\t{\n\t\tthis.signedParameters = params.signedParameters;\n\t\tthis.componentName = params.componentName;\n\t\tthis.loader = null;\n\t\tthis.container = params.contentContainer;\n\t\tthis.userId = params.userId;\n\t\tthis.currentPage = params.currentPage;\n\t\tthis.menuContainer = params.menuContainer;\n\n\t\tthis.changeContent(this.currentPage);\n\n\t\tif (Type.isDomNode(this.menuContainer))\n\t\t{\n\t\t\tthis.menuItems = this.menuContainer.querySelectorAll(\"a\");\n\n\t\t\t(this.menuItems || []).forEach((item) => {\n\t\t\t\tEvent.bind(item, 'click', () => {\n\t\t\t\t\tthis.changeContent(item.getAttribute('data-action'));\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\n\t\tBX.addCustomEvent('BX.Security.UserOtpInit:afterOtpSetup', function(event) {\n\t\t\tthis.showOtpConnectedComponent();\n\t\t}.bind(this));\n\t}\n\n\tchangeContent(action)\n\t{\n\t\tif (!action)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tswitch (action)\n\t\t{\n\t\t\tcase \"auth\":\n\t\t\tcase \"otpConnected\":\n\t\t\tcase \"socnetEmail\":\n\t\t\t\tconst requestData = {\n\t\t\t\t\tuserId: this.userId\n\t\t\t\t};\n\t\t\t\tthis.sendAction(action, requestData);\n\t\t\t\tbreak;\n\n\t\t\tcase \"otp\":\n\t\t\tcase \"appPasswords\":\n\t\t\tcase \"synchronize\":\n\t\t\tcase \"mailingAgreement\":\n\t\t\tcase \"sso\":\n\t\t\t\tthis.sendAction(action, {});\n\t\t\t\tbreak;\n\n\t\t\tcase \"recoveryCodes\":\n\t\t\t\tthis.showRecoveryCodesComponent();\n\t\t\t\tbreak;\n\n\t\t\tcase \"socserv\":\n\t\t\t\tthis.showSocservComponent();\n\t\t\t\tbreak;\n\t\t}\n\t}\n\n\tclearHtml()\n\t{\n\t\tBX.html(this.container, \"\");\n\t\tconst uiButtons = document.getElementsByClassName(\"ui-entity-wrap\");\n\t\tif (uiButtons && uiButtons[0])\n\t\t{\n\t\t\tDom.remove(uiButtons[0]);\n\t\t}\n\t}\n\n\tsendAction(action, requestData)\n\t{\n\t\tthis.clearHtml();\n\t\tthis.loader = this.showLoader({node: this.container, loader: null, size: 100});\n\n\t\tBX.ajax.runComponentAction(this.componentName, action, {\n\t\t\tsignedParameters: this.signedParameters,\n\t\t\tmode: 'ajax',\n\t\t\tdata: requestData\n\t\t}).then(function (response) {\n\t\t\tthis.showComponentData(response, action);\n\t\t}.bind(this), function (response) {\n\t\t\tthis.showErrorPopup(response[\"errors\"][0].message);\n\t\t\tthis.hideLoader({loader: this.loader});\n\t\t}.bind(this));\n\t}\n\n\tshowOtpComponent()\n\t{\n\t\tthis.changeContent(\"otp\");\n\t}\n\n\tshowOtpConnectedComponent()\n\t{\n\t\tthis.changeContent(\"otpConnected\");\n\t}\n\n\tshowRecoveryCodesComponent(componentMode)\n\t{\n\t\tif (!componentMode)\n\t\t{\n\t\t\tcomponentMode = \"\";\n\t\t}\n\n\t\tthis.sendAction(\"recoveryCodes\", {componentMode: componentMode});\n\t}\n\n\tshowSocservComponent()\n\t{\n\t\tthis.clearHtml();\n\t\tconst socServNode = document.querySelector(\"[data-action='socserv']\");\n\t\tif (BX.type.isDomNode(socServNode))\n\t\t{\n\t\t\tconst url = BX.data(socServNode, 'url');\n\t\t\tif (top.BX.SidePanel.Instance.open(url, {\n\t\t\t\t'cacheable': false,\n\t\t\t\t'width': 840\n\t\t\t}))\n\t\t\t{\n\t\t\t\ttop.BX.addCustomEvent(top.BX.SidePanel.Instance.getSlider(url), \"SidePanel.Slider:onClose\", BX.proxy(function () {\n\t\t\t\t\tconst authNode = document.querySelector(\"[data-action='auth']\");\n\t\t\t\t\tif (BX.type.isDomNode(authNode))\n\t\t\t\t\t{\n\t\t\t\t\t\tauthNode.click();\n\t\t\t\t\t}\n\t\t\t\t}, this));\n\t\t\t}\n\t\t}\n\t}\n\n\tshowComponentData(result, pageName)\n\t{\n\t\tconst errors = BX.prop.getArray(result, \"errors\", []);\n\t\tif (errors.length > 0)\n\t\t{\n\t\t\tthis.showErrorPopup(result[\"errors\"][0].message);\n\t\t\treturn;\n\t\t}\n\n\t\tif (!result.data)\n\t\t{\n\t\t\tthis.showErrorPopup(\"Unknown error\");\n\t\t\tthis.hideLoader({loader: this.loader});\n\t\t\treturn;\n\t\t}\n\n\t\tconst promise = new Promise(BX.delegate(function(resolve, reject) {\n\t\t\tif (result.data.hasOwnProperty(\"assets\") && result.data.assets['css'].length)\n\t\t\t{\n\t\t\t\tBX.load(result.data.assets['css'], function () {\n\t\t\t\t\tif (result.data.assets['js'].length)\n\t\t\t\t\t{\n\t\t\t\t\t\tBX.load(result.data.assets['js'], function () {\n\t\t\t\t\t\t\tif (result.data.assets['string'].length)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tfor (var i = 0; i < result.data.assets['string'].length; i++)\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tBX.html(null, result.data.assets['string'][i]);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tresolve();\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t}, this));\n\n\t\tpromise.then(\n\t\t\tBX.delegate(function(){\n\t\t\t\tconst html = BX.prop.getString(result.data, \"html\", '');\n\t\t\t\tBX.html(this.container, html);\n\n\t\t\t\tconst pageTitle = BX.prop.getString(BX.prop.getObject(result.data, \"additionalParams\", ''), \"pageTitle\", \"\");\n\t\t\t\tBX.html(BX(\"pagetitle\"), pageTitle);\n\n\t\t\t\ttop.history.pushState(null, \"\", \"?page=\" + pageName);\n\t\t\t},this)\n\t\t);\n\t}\n\n\tshowLoader(params)\n\t{\n\t\tlet loader = null;\n\n\t\tif (params.node)\n\t\t{\n\t\t\tif (params.loader === null)\n\t\t\t{\n\t\t\t\tloader = new BX.Loader({\n\t\t\t\t\ttarget: params.node,\n\t\t\t\t\tsize: params.hasOwnProperty(\"size\") ? params.size : 40\n\t\t\t\t});\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tloader = params.loader;\n\t\t\t}\n\n\t\t\tloader.show();\n\t\t}\n\n\t\treturn loader;\n\t}\n\n\thideLoader(params)\n\t{\n\t\tif (params.loader !== null)\n\t\t{\n\t\t\tparams.loader.hide();\n\t\t}\n\n\t\tif (params.node)\n\t\t{\n\t\t\tDom.clean(params.node);\n\t\t}\n\n\t\tif (params.loader !== null)\n\t\t{\n\t\t\tparams.loader = null;\n\t\t}\n\t}\n\n\tshowErrorPopup(error)\n\t{\n\t\tif (!error)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tBX.PopupWindowManager.create({\n\t\t\tid: \"intranet-user-profile-error-popup\",\n\t\t\tcontent:\n\t\t\t\tBX.create(\"div\", {\n\t\t\t\t\tprops : {\n\t\t\t\t\t\tstyle : \"max-width: 450px\"\n\t\t\t\t\t},\n\t\t\t\t\thtml: BX.util.htmlspecialchars(error)\n\t\t\t\t}),\n\t\t\tcloseIcon : true,\n\t\t\tlightShadow : true,\n\t\t\toffsetLeft : 100,\n\t\t\toverlay : false,\n\t\t\tcontentPadding: 10\n\t\t}).show();\n\t}\n}"],"names":["Security","params","signedParameters","componentName","loader","container","contentContainer","userId","currentPage","menuContainer","changeContent","Type","isDomNode","menuItems","querySelectorAll","forEach","item","Event","bind","getAttribute","BX","addCustomEvent","event","showOtpConnectedComponent","action","requestData","sendAction","showRecoveryCodesComponent","showSocservComponent","html","uiButtons","document","getElementsByClassName","Dom","remove","clearHtml","showLoader","node","size","ajax","runComponentAction","mode","data","then","response","showComponentData","showErrorPopup","message","hideLoader","componentMode","socServNode","querySelector","type","url","top","SidePanel","Instance","open","getSlider","proxy","authNode","click","result","pageName","errors","prop","getArray","length","promise","Promise","delegate","resolve","reject","hasOwnProperty","assets","load","i","getString","pageTitle","getObject","history","pushState","Loader","target","show","hide","clean","error","PopupWindowManager","create","id","content","props","style","util","htmlspecialchars","closeIcon","lightShadow","offsetLeft","overlay","contentPadding"],"mappings":"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"}